---
- name: mount gluster volumes
  hosts: all:!offline
  gather_facts: false
  become: true

  pre_tasks:
    - name: load vault
      include_vars:
        file: ~/.ansible/.picocluster.yml
      run_once: true
      no_log: true
      tags: ['always']

  vars:
    mountpoint: "/mnt/{{ glustervol }}"
    glustervol: 'myvol1'

  tasks:
    - name: mountpoint exists
      ansible.builtin.file:
        path: "{{ mountpoint }}"
        state: directory

    - name: Mounting myvol1
      ansible.posix.mount:
        path: "{{ mountpoint }}"
        src: "{{ inventory_hostname }}:/{{ glustervol }}"
        fstype: glusterfs
        opts: "defaults,_netdev"
        state: mounted

    - name: drop a testfile
      ansible.builtin.file:
        path: "{{ mountpoint }}/.{{ inventory_hostname }}"
        state: touch